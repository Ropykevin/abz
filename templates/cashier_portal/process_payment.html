{% extends "base.html" %}

{% block title %}Process Payment - Order #{{ order.id }} - ABZ Cashier Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-credit-card me-2"></i>Process Payment
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('orders') }}">Orders</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('view_order', order_id=order.id) }}">Order #{{ order.id }}</a></li>
                        <li class="breadcrumb-item active">Process Payment</li>
                    </ol>
                </nav>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('view_order', order_id=order.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Order
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Order Summary -->
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>Order Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="avatar-lg bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3">
                        <span class="text-white fw-bold fs-1">{{ order.user.firstname[0] }}{{ order.user.lastname[0] }}</span>
                    </div>
                    <h5 class="mb-1">{{ order.user.firstname }} {{ order.user.lastname }}</h5>
                    <p class="text-muted mb-2">{{ order.user.email }}</p>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted">Order ID</small>
                            <div class="fw-bold">#{{ order.id }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <small class="text-muted">Status</small>
                            <div class="fw-bold">
                                {% if order.approvalstatus %}
                                    <span class="badge bg-success">Approved</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <h4 class="text-primary mb-0">KSH {{ "{:,.2f}".format(total_amount|default(0)|float) }}</h4>
                    <small class="text-muted">Order Total</small>
                </div>
                {% if total_payments and total_payments > 0 %}
                <hr>
                <div class="text-center">
                    <h6 class="text-success mb-0">KSH {{ "{:,.2f}".format(total_payments|default(0)|float) }}</h6>
                    <small class="text-muted">Already Paid</small>
                </div>
                <div class="text-center mt-2">
                    <h6 class="text-warning mb-0">KSH {{ "{:,.2f}".format((total_amount - total_payments)|default(0)|float) }}</h6>
                    <small class="text-muted">Remaining Amount</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Payment History -->
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Payment History
                </h5>
            </div>
            <div class="card-body">
                {% if order.payments %}
                    {% for payment in order.payments %}
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary">Payment #{{ payment.id }}</span>
                            <span class="badge 
                                {% if payment.payment_status == 'completed' %}bg-success
                                {% elif payment.payment_status == 'pending' %}bg-warning
                                {% elif payment.payment_status == 'failed' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ payment.payment_status|title }}
                            </span>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Amount</small>
                                <div class="fw-bold">KSH {{ "{:,.2f}".format(payment.amount) }}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Method</small>
                                <div>{{ payment.payment_method|title }}</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Date: {{ payment.created_at|east_africa_time|strftime('%m/%d/%Y %H:%M') }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-credit-card fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No payments recorded</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Payment Form -->
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-credit-card me-2"></i>Create New Payment
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> All payments created through this form are automatically marked as completed. This is the standard process for cashier payments.
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Payment Amount (KSH) *</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="amount" 
                                   name="amount" 
                                   step="0.01" 
                                   min="0.01" 
                                   value="{{ remaining|default('0.00') }}"
                                   required>
                            <div class="form-text">Amount defaults to remaining balance. Adjust as needed.</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="payment_method" class="form-label">Payment Method *</label>
                            <select class="form-select" id="payment_method" name="payment_method" required>
                                <option value="">Select Payment Method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="reference_number" class="form-label">Reference Number</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="reference_number" 
                                   name="reference_number" 
                                   placeholder="Transaction ID, Receipt No., etc.">
                            <div class="form-text">Optional reference for tracking</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" 
                                  id="notes" 
                                  name="notes" 
                                  rows="3" 
                                  placeholder="Additional payment details, customer notes, etc."></textarea>
                    </div>

                    {% if total_payments and total_payments > 0 %}
                        {% set remaining = total_amount - total_payments %}
                        {% if remaining > 0 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Partial Payment:</strong> This order has KSH {{ "{:,.2f}".format(total_payments|float) }} already paid. 
                                Remaining amount: KSH {{ "{:,.2f}".format(remaining|float) }}. 
                                <div id="payment-completion-status" style="display: none;">
                                    <strong class="text-success">This payment will complete the order!</strong>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Order Already Paid:</strong> This order has been fully paid (KSH {{ "{:,.2f}".format(total_payments|float) }}).
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> This payment will be created and linked to Order #{{ order.id }}. 
                            <div id="payment-completion-status" style="display: none;">
                                <strong class="text-success">This payment will complete the order!</strong>
                            </div>
                        </div>
                    {% endif %}

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success" id="create-payment-btn">
                            <i class="fas fa-credit-card me-2"></i><span id="btn-text">Create Payment</span>
                        </button>
                        <a href="{{ url_for('view_order', order_id=order.id) }}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('view_order', order_id=order.id) }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-eye me-2"></i>View Order
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('payments') }}" class="btn btn-outline-info w-100">
                            <i class="fas fa-list me-2"></i>All Payments
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('orders') }}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-arrow-left me-2"></i>Back to Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-fill payment method based on common patterns
document.getElementById('payment_method').addEventListener('change', function() {
    const method = this.value;
    const notesField = document.getElementById('notes');
    
    if (method === 'mobile_money') {
        notesField.placeholder = 'Mobile money provider (M-Pesa, Airtel Money, etc.) and phone number';
    } else if (method === 'bank_transfer') {
        notesField.placeholder = 'Bank name, account number, and transfer reference';
    } else if (method === 'card') {
        notesField.placeholder = 'Card type (Visa, Mastercard, etc.) and last 4 digits';
    } else {
        notesField.placeholder = 'Additional payment details, customer notes, etc.';
    }
});

// Validate amount and show payment completion status
document.getElementById('amount').addEventListener('input', function() {
    const amount = parseFloat(this.value) || 0;
    const orderTotal = {{ total_amount|default(0) }};
    const totalPayments = {{ total_payments|default(0) }};
    const remaining = orderTotal - totalPayments;
    
    // Validate amount
    if (amount > orderTotal) {
        this.setCustomValidity('Payment amount cannot exceed order total');
    } else {
        this.setCustomValidity('');
    }
    
    // Show/hide payment completion status
    const completionStatus = document.getElementById('payment-completion-status');
    if (completionStatus) {
        if (amount >= remaining && remaining > 0) {
            completionStatus.style.display = 'block';
        } else if (amount >= orderTotal && totalPayments === 0) {
            completionStatus.style.display = 'block';
        } else {
            completionStatus.style.display = 'none';
        }
    }
});

// Prevent multiple form submissions
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('create-payment-btn');
    const btnText = document.getElementById('btn-text');
    let isSubmitting = false;
    
    form.addEventListener('submit', function(e) {
        if (isSubmitting) {
            e.preventDefault();
            return false;
        }
        
        isSubmitting = true;
        submitBtn.disabled = true;
        btnText.textContent = 'Processing...';
        submitBtn.classList.add('disabled');
        
        // Add a spinner icon
        const icon = submitBtn.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-spinner fa-spin me-2';
        }
        
        // Re-enable button after 10 seconds as a safety measure
        setTimeout(function() {
            if (isSubmitting) {
                isSubmitting = false;
                submitBtn.disabled = false;
                btnText.textContent = 'Create Payment';
                submitBtn.classList.remove('disabled');
                if (icon) {
                    icon.className = 'fas fa-credit-card me-2';
                }
            }
        }, 10000);
    });
});
</script>
{% endblock %}
