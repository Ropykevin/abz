{% extends "navbars.html" %}

<!-- END nav -->
{% block content %}
<style>
.action-buttons {
  display: flex;
  gap: 2px;
  flex-wrap: wrap;
}
.action-buttons .btn {
  min-width: 32px;
  height: 32px;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

/* Search Bar Styling */
.search-container {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 1px solid #e9ecef;
}

.search-container .input-group {
  margin-bottom: 10px;
}

.search-container .form-control {
  border-radius: 6px;
}

.search-container .input-group-text {
  background-color: #fff;
  border-right: none;
}

.search-container .form-control {
  border-left: none;
}

.search-container .form-control:focus {
  box-shadow: none;
  border-color: #ced4da;
}

/* Filter Styling */
.filter-container {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.filter-container .form-control {
  min-width: 150px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .filter-container {
    flex-direction: column;
    align-items: stretch;
  }
  
  .filter-container .form-control {
    min-width: auto;
  }
}
</style>

<!-- Search functionality disabled - using simple form-based search instead -->
<!-- <script src="{{ url_for('static', filename='js/search.js') }}"></script> -->

<div class="container">
  <div class="page-inner">
    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
      <div>
        <h3 class="fw-bold mb-3">Branch Products Management</h3>
        <h6 class="op-7 mb-2">Manage branch-specific products, pricing, and stock levels</h6>
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <div class="btn-group" role="group">
          <!-- <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-building"></i> View by Branch
          </button> -->
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('products') }}">All Products</a></li>
            <li><hr class="dropdown-divider"></li>
            {% for branch in branches %}
            <li><a class="dropdown-item" href="{{ url_for('branch_products', branch_id=branch.id) }}">{{ branch.name }}</a></li>
            {% endfor %}
          </ul>
        </div>
        <button class="btn btn-primary btn-round ms-2" data-bs-toggle="modal" data-bs-target="#addExistingProductModal">
          <i class="fas fa-list"></i> Add Existing Product
        </button>
        <button class="btn btn-success btn-round ms-2" data-bs-toggle="modal" data-bs-target="#addNewProductModal">
          <i class="fas fa-plus"></i> Add New Product
        </button>
      </div>
    </div>

    <!-- Branch Selection -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card card-round">
          <div class="card-header">
            <h4 class="card-title">Select Branch</h4>
          </div>
          <div class="card-body">
            <form method="GET" action="{{ url_for('products') }}" class="row align-items-end">
              <div class="col-md-4">
                <label for="branchSelect" class="form-label">Choose Branch</label>
                <select class="form-control" id="branchSelect" name="branch_id" onchange="this.form.submit()">
                  {% for branch in branches %}
                  <option value="{{ branch.id }}" {% if selected_branch_id == branch.id %}selected{% endif %}>
                    {{ branch.name }} - {{ branch.location }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Filter</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Categories Section -->
  

    <!-- Products Section -->
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <h4 class="card-title">
                Products
                {% if selected_branch_id %}
                  {% for branch in branches %}
                    {% if branch.id == selected_branch_id %}
                      - {{ branch.name }}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              </h4>
              <div class="card-tools">
                <button class="btn btn-icon btn-link btn-primary btn-xs" data-bs-toggle="collapse" data-bs-target="#productsCollapse">
                  <span class="fa fa-angle-down"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="card-body collapse show" id="productsCollapse">
            <!-- Products Search Bar -->
            <div class="search-container">
              <div class="filter-container">
                <form method="GET" action="{{ url_for('products') }}" class="row g-3">
                  <div class="col-md-3">
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-search"></i></span>
                      <input type="text" class="form-control" id="productSearch" name="search" 
                             value="{{ search }}" placeholder="Search products by name, code, or category...">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <select class="form-control" id="categoryFilter" name="category">
                      <option value="">All Categories</option>
                      {% for subcategory in subcategories %}
                      <option value="{{ subcategory.name }}" {% if category_filter == subcategory.name %}selected{% endif %}>
                        {{ subcategory.name }} ({{ subcategory.category.name }})
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-2">
                    <select class="form-control" id="displayFilter" name="display">
                      <option value="">All Products</option>
                      <option value="true" {% if display_filter == 'true' %}selected{% endif %}>Visible Only</option>
                      <option value="false" {% if display_filter == 'false' %}selected{% endif %}>Hidden Only</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <select class="form-control" name="per_page">
                      <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10 per page</option>
                      <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25 per page</option>
                      <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50 per page</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-search"></i> Search
                    </button>
                    <a href="{{ url_for('products') }}" class="btn btn-secondary">
                      <i class="fas fa-times"></i> Clear
                    </a>
                  </div>
                  {% if selected_branch_id %}
                  <input type="hidden" name="branch_id" value="{{ selected_branch_id }}">
                  {% endif %}
                </form>
              </div>
              
              <!-- Export Section -->
              <div class="mt-3 d-flex justify-content-end gap-2">
                <a href="{{ url_for('export_products_csv') }}{% if selected_branch_id %}?branch_id={{ selected_branch_id }}{% endif %}" 
                   class="btn btn-success btn-sm">
                  <i class="fas fa-download"></i> Export All to CSV
                </a>
                <a href="{{ url_for('export_products_by_category_csv') }}{% if selected_branch_id %}?branch_id={{ selected_branch_id }}{% endif %}" 
                   class="btn btn-primary btn-sm">
                  <i class="fas fa-layer-group"></i> Export by Category (CSV)
                </a>
                <a href="{{ url_for('export_products_by_category_pdf') }}{% if selected_branch_id %}?branch_id={{ selected_branch_id }}{% endif %}" 
                   class="btn btn-danger btn-sm">
                  <i class="fas fa-file-pdf"></i> Export by Category (PDF)
                </a>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover" id="productsTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Branch</th>
                    <th>Buying Price</th>
                    <th>Selling Price</th>
                    <th>Stock</th>
                    <th>Product Code</th>
                    <th>Display</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in products %}
                  <tr>
                    <td>{{ product.id }}</td>
                    <td>
                      {% if product.catalog_product and product.catalog_product.image_url %}
                      <img src="{{ product.catalog_product.image_url }}" alt="{{ product.catalog_product.name }}" style="width: 50px; height: 50px; object-fit: cover;">
                      {% else %}
                      <span class="text-muted">No image</span>
                      {% endif %}
                    </td>
                    <td>{{ (product.catalog_product.name if product.catalog_product else 'Unknown Product') | upper }}</td>

                    <td>
                      {% if product.catalog_product and product.catalog_product.sub_category %}
                        <span class="badge bg-primary">{{ product.catalog_product.sub_category.name }}</span>
                        <br><small class="text-muted">{{ product.catalog_product.sub_category.category.name }}</small>
                      {% else %}
                        <span class="text-muted">No category</span>
                      {% endif %}
                    </td>
                    <td>
                      {% for branch in branches %}
                        {% if branch.id == product.branchid %}
                          <span class="badge bg-info">{{ branch.name }}</span>
                        {% endif %}
                      {% endfor %}
                    </td>
                    <td>{{ product.buyingprice }}</td>
                    <td>{{ product.sellingprice }}</td>
                    <td>{{ product.stock | format_stock }}</td>
                    <td>{{ product.catalog_product.productcode if product.catalog_product else 'N/A' }}</td>
                    <td>
                      <form action="{{ url_for('toggle_display', branch_product_id=product.id) }}" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-sm {% if product.display %}btn-success{% else %}btn-secondary{% endif %}" title="{% if product.display %}Visible in customer app{% else %}Hidden from customer app{% endif %}">
                          <i class="fas {% if product.display %}fa-eye{% else %}fa-eye-slash{% endif %}"></i>
                        </button>
                      </form>
                      <small class="d-block text-muted">
                        {% if product.display %}Visible{% else %}Hidden{% endif %}
                      </small>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addStockModal{{ product.id }}" title="Add Stock">
                          <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#removeStockModal{{ product.id }}" title="Remove Stock">
                          <i class="fas fa-minus"></i>
                        </button>
                        <button class="btn btn-info btn-sm" onclick="window.location.href='{{ url_for('stock_history', branch_product_id=product.id) }}'" title="Stock History">
                          <i class="fas fa-history"></i>
                        </button>
                        <a href="{{ url_for('product_descriptions', product_id=product.catalog_product.id) if product.catalog_product else '#' }}" class="btn btn-secondary btn-sm" title="Manage Descriptions">
                          <i class="fas fa-file-alt"></i>
                        </a>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProductModal{{ product.id }}" title="Edit Product">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteProductModal{{ product.id }}" title="Delete Product">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>

                  <!-- Edit Product Modal -->
                  <div class="modal fade" id="editProductModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Edit Product</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="{{ url_for('edit_branch_product', id=product.id) }}" method="POST" enctype="multipart/form-data">
                          <div class="modal-body">
                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label for="editProductName{{ product.id }}" class="form-label">Name</label>
                                  <input type="text" class="form-control" id="editProductName{{ product.id }}" name="name" value="{{ product.catalog_product.name if product.catalog_product else '' }}" required readonly>
                                  <small class="form-text text-muted">Product name cannot be changed here. Edit in catalog.</small>
                                </div>
                                <div class="mb-3">
                                  <label for="editProductSubcategory{{ product.id }}" class="form-label">Subcategory</label>
                                  <select class="form-control" id="editProductSubcategory{{ product.id }}" name="subcategory_id" disabled>
                                    <option value="">No subcategory</option>
                                    {% for subcategory in subcategories %}
                                    <option value="{{ subcategory.id }}" {% if product.catalog_product and subcategory.id == product.catalog_product.subcategory_id %}selected{% endif %}>
                                      {{ subcategory.name }} ({{ subcategory.category.name }})
                                    </option>
                                    {% endfor %}
                                  </select>
                                  <small class="form-text text-muted">Category cannot be changed here. Edit in catalog.</small>
                                </div>
                                <div class="mb-3">
                                  <label for="editProductBranch{{ product.id }}" class="form-label">Branch</label>
                                  <select class="form-control" id="editProductBranch{{ product.id }}" name="branchid" required>
                                    {% for branch in branches %}
                                    <option value="{{ branch.id }}" {% if branch.id == product.branchid %}selected{% endif %}>{{ branch.name }} - {{ branch.location }}</option>
                                    {% endfor %}
                                  </select>
                                </div>
                                <div class="mb-3">
                                  <label for="editProductBuyingPrice{{ product.id }}" class="form-label">Buying Price</label>
                                  <input type="number" class="form-control" id="editProductBuyingPrice{{ product.id }}" name="buyingprice" value="{{ product.buyingprice }}">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label for="editProductSellingPrice{{ product.id }}" class="form-label">Selling Price</label>
                                  <input type="number" class="form-control" id="editProductSellingPrice{{ product.id }}" name="sellingprice" value="{{ product.sellingprice }}">
                                </div>
                                <div class="mb-3">
                                  <label for="editProductStock{{ product.id }}" class="form-label">Stock</label>
                                  <input type="number" class="form-control" id="editProductStock{{ product.id }}" name="stock" value="{{ product.stock }}">
                                </div>
                                <div class="mb-3">
                                  <label for="editProductCode{{ product.id }}" class="form-label">Product Code</label>
                                  <input type="text" class="form-control" id="editProductCode{{ product.id }}" name="productcode" value="{{ product.catalog_product.productcode if product.catalog_product else '' }}" readonly>
                                  <small class="form-text text-muted">Product code cannot be changed here. Edit in catalog.</small>
                                </div>
                                <div class="mb-3">
                                  <label for="editProductImage{{ product.id }}" class="form-label">Product Image</label>
                                  <input type="file" class="form-control" id="editProductImage{{ product.id }}" name="image" disabled>
                                  {% if product.catalog_product and product.catalog_product.image_url %}
                                  <small class="text-muted">Current: {{ product.catalog_product.image_url }}</small>
                                  {% endif %}
                                  <small class="form-text text-muted">Product image cannot be changed here. Edit in catalog.</small>
                                </div>
                                <div class="mb-3">
                                  <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editProductDisplay{{ product.id }}" name="display" {% if product.display %}checked{% endif %}>
                                    <label class="form-check-label" for="editProductDisplay{{ product.id }}">
                                      Display in customer app
                                    </label>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Delete Product Modal -->
                  <div class="modal fade" id="deleteProductModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Delete Product</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="{{ url_for('delete_branch_product', id=product.id) }}" method="POST">
                          <div class="modal-body">
                            <p>Are you sure you want to delete this product? This action cannot be undone.</p>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Delete</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Add Stock Modal -->
                  <div class="modal fade" id="addStockModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Add Stock - {{ product.name }}</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="{{ url_for('add_stock', branch_product_id=product.id) }}" method="POST">
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="form-label">Current Stock</label>
                              <input type="text" class="form-control" value="{{ product.stock | format_stock }}" readonly>
                            </div>
                            <div class="mb-3">
                              <label for="addStockQuantity{{ product.id }}" class="form-label">Quantity to Add</label>
                              <input type="number" class="form-control" id="addStockQuantity{{ product.id }}" name="quantity" min="1" required>
                            </div>
                            <div class="mb-3">
                              <label for="addStockNotes{{ product.id }}" class="form-label">Notes (Optional)</label>
                              <textarea class="form-control" id="addStockNotes{{ product.id }}" name="notes" rows="3" placeholder="Reason for adding stock..."></textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Add Stock</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Remove Stock Modal -->
                  <div class="modal fade" id="removeStockModal{{ product.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Remove Stock - {{ product.name }}</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="{{ url_for('remove_stock', branch_product_id=product.id) }}" method="POST">
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="form-label">Current Stock</label>
                              <input type="text" class="form-control" value="{{ product.stock | format_stock }}" readonly>
                            </div>
                            <div class="mb-3">
                              <label for="removeStockQuantity{{ product.id }}" class="form-label">Quantity to Remove</label>
                              <input type="number" class="form-control" id="removeStockQuantity{{ product.id }}" name="quantity" min="1" max="{{ product.stock or 0 }}" required>
                            </div>
                            <div class="mb-3">
                              <label for="removeStockNotes{{ product.id }}" class="form-label">Notes (Optional)</label>
                              <textarea class="form-control" id="removeStockNotes{{ product.id }}" name="notes" rows="3" placeholder="Reason for removing stock..."></textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">Remove Stock</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="pagination-info">
                <small class="text-muted">
                  {% if pagination %}
                    Showing {{ pagination.items|length }} of {{ pagination.total }} products
                    {% if selected_branch_id %}
                      {% for branch in branches %}
                        {% if branch.id == selected_branch_id %}
                          in {{ branch.name }}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% else %}
                    Showing all products
                  {% endif %}
                </small>
              </div>
              
              {% if pagination and pagination.pages > 1 %}
              <nav aria-label="Products pagination">
                <ul class="pagination pagination-sm mb-0">
                  {% if pagination.has_prev %}
                    <li class="page-item">
                      <a class="page-link" href="{{ url_for('products', page=pagination.prev_num, branch_id=selected_branch_id, per_page=request.args.get('per_page', 10), search=search, category=category_filter, display=display_filter) }}">&laquo;</a>
                    </li>
                  {% endif %}
                  
                  {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                      {% if page_num != pagination.page %}
                        <li class="page-item">
                          <a class="page-link" href="{{ url_for('products', page=page_num, branch_id=selected_branch_id, per_page=request.args.get('per_page', 10), search=search, category=category_filter, display=display_filter) }}">{{ page_num }}</a>
                        </li>
                      {% else %}
                        <li class="page-item active">
                          <span class="page-link">{{ page_num }}</span>
                        </li>
                      {% endif %}
                    {% else %}
                      <li class="page-item disabled">
                        <span class="page-link">...</span>
                      </li>
                    {% endif %}
                  {% endfor %}
                  
                  {% if pagination.has_next %}
                    <li class="page-item">
                      <a class="page-link" href="{{ url_for('products', page=pagination.next_num, branch_id=selected_branch_id, per_page=request.args.get('per_page', 10), search=search, category=category_filter, display=display_filter) }}">&raquo;</a>
                    </li>
                  {% endif %}
                </ul>
              </nav>
              {% else %}
              <div class="text-muted">
                <small>Page 1 of 1</small>
              </div>
              {% endif %}
              
              <!-- Items per page selector -->
              <div class="items-per-page">
                <small class="text-muted">Items per page:</small>
                <select class="form-select form-select-sm d-inline-block w-auto ms-2" onchange="changeItemsPerPage(this.value)">
                  <option value="5" {% if request.args.get('per_page', '10') == '5' %}selected{% endif %}>5</option>
                  <option value="10" {% if request.args.get('per_page', '10') == '10' %}selected{% endif %}>10</option>
                  <option value="25" {% if request.args.get('per_page', '10') == '25' %}selected{% endif %}>25</option>
                  <option value="50" {% if request.args.get('per_page', '10') == '50' %}selected{% endif %}>50</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('add_category') }}" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="categoryName" class="form-label">Name</label>
            <input type="text" class="form-control" id="categoryName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="categoryDescription" class="form-label">Description</label>
            <textarea class="form-control" id="categoryDescription" name="description"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Add Category</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Existing Product Modal -->
<div class="modal fade" id="addExistingProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-list"></i> Add Existing Product to Branch</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('add_branch_product') }}" method="POST">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="catalog_id" class="form-label">Select Product from Catalog *</label>
                <input type="text" class="form-control mb-2" id="catalogSearch" placeholder="Search products..." onkeyup="searchCatalogProducts()">
                <select class="form-control" id="catalog_id" name="catalog_id" required>
                  <option value="">Select Product</option>
                </select>
                <small class="form-text text-muted">Choose from existing products in the catalog (not already in this branch)</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="branchid" class="form-label">Branch *</label>
                <select class="form-control" id="branchid" name="branchid" required>
                  {% for branch in branches %}
                  <option value="{{ branch.id }}" {% if selected_branch_id == branch.id %}selected{% endif %}>{{ branch.name }} - {{ branch.location }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="buyingprice" class="form-label">Buying Price</label>
                <input type="number" class="form-control" id="buyingprice" name="buyingprice" min="0" step="0.01">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="sellingprice" class="form-label">Selling Price</label>
                <input type="number" class="form-control" id="sellingprice" name="sellingprice" min="0" step="0.01">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="stock" class="form-label">Initial Stock</label>
                <input type="number" class="form-control" id="stock" name="stock" min="0" value="0">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="display" name="display" checked>
                  <label class="form-check-label" for="display">
                    Visible to customers
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Add to Branch</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add New Product Modal -->
<div class="modal fade" id="addNewProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Product to Branch</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('add_new_product_to_branch') }}" method="POST" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="productName" class="form-label">Product Name *</label>
                <input type="text" class="form-control" id="productName" name="name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="productCode" class="form-label">Product Code</label>
                <input type="text" class="form-control" id="productCode" name="productcode">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="productSubcategory" class="form-label">Subcategory</label>
                <select class="form-control" id="productSubcategory" name="subcategory_id">
                  <option value="">No subcategory</option>
                  {% for subcategory in subcategories %}
                  <option value="{{ subcategory.id }}">{{ subcategory.name }} ({{ subcategory.category.name }})</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="productImage" class="form-label">Product Image</label>
                <input type="file" class="form-control" id="productImage" name="image" accept="image/*">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="newBuyingprice" class="form-label">Buying Price</label>
                <input type="number" class="form-control" id="newBuyingprice" name="buyingprice" min="0" step="0.01">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="newSellingprice" class="form-label">Selling Price</label>
                <input type="number" class="form-control" id="newSellingprice" name="sellingprice" min="0" step="0.01">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="newStock" class="form-label">Initial Stock</label>
                <input type="number" class="form-control" id="newStock" name="stock" min="0" value="0">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="newDisplay" name="display" checked>
                  <label class="form-check-label" for="newDisplay">
                    Visible to customers
                  </label>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newBranchid" class="form-label">Branch *</label>
                <select class="form-control" id="newBranchid" name="branchid" required>
                  {% for branch in branches %}
                  <option value="{{ branch.id }}" {% if selected_branch_id == branch.id %}selected{% endif %}>{{ branch.name }} - {{ branch.location }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success">Create & Add to Branch</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing search functionality...');
    
    // Category Search Functionality
    const categorySearch = document.getElementById('categorySearch');
    if (categorySearch) {
        console.log('Category search element found');
        categorySearch.addEventListener('keyup', function() {
            console.log('Category search triggered:', this.value);
            const searchTerm = this.value.toLowerCase();
            const table = document.getElementById('categoriesTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const nameCell = rows[i].getElementsByTagName('td')[1];
                const descCell = rows[i].getElementsByTagName('td')[2];
                
                if (nameCell && descCell) {
                    const name = nameCell.textContent.toLowerCase();
                    const description = descCell.textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || description.includes(searchTerm)) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        });
    } else {
        console.log('Category search element not found');
    }
    
    // Server-side search is now handled by the form submission
    // No need for client-side filtering anymore
    
    // Function to change items per page
    window.changeItemsPerPage = function(perPage) {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('per_page', perPage);
        currentUrl.searchParams.set('page', '1'); // Reset to first page
        window.location.href = currentUrl.toString();
    };
    
    // Load catalog products for existing product modal
    loadCatalogProducts();
    
    console.log('Search functionality initialized successfully');
});

// Store all products for search functionality
let allCatalogProducts = [];

// Load catalog products for the add existing product modal
function loadCatalogProducts() {
    const branchId = document.getElementById('branchid')?.value || null;
    if (branchId) {
        fetch(`/get_catalog_products_for_branch?branch_id=${branchId}`)
            .then(response => response.json())
            .then(products => {
                allCatalogProducts = products; // Store all products
                const select = document.getElementById('catalog_id');
                if (select) {
                    select.innerHTML = '<option value="">Select Product</option>';
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.productcode || 'No Code'})`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading catalog products:', error);
            });
    }
}

// Search catalog products
function searchCatalogProducts() {
    const searchTerm = document.getElementById('catalogSearch').value.toLowerCase();
    const select = document.getElementById('catalog_id');
    
    if (select) {
        select.innerHTML = '<option value="">Select Product</option>';
        
        allCatalogProducts.forEach(product => {
            const productText = `${product.name} (${product.productcode || 'No Code'})`.toLowerCase();
            if (productText.includes(searchTerm)) {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.productcode || 'No Code'})`;
                select.appendChild(option);
            }
        });
    }
}

// Load catalog products when branch changes in existing product modal
document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'branchid') {
        // Clear search input when branch changes
        const searchInput = document.getElementById('catalogSearch');
        if (searchInput) {
            searchInput.value = '';
        }
        loadCatalogProducts();
    }
});
</script>

{% endblock %}