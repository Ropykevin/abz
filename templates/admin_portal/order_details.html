{% extends "navbars.html" %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
      <div>
        <h3 class="fw-bold mb-3">Order Details</h3>
        <h6 class="op-7 mb-2">Order #{{ order.id }}</h6>
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <a href="{{ url_for('orders') }}" class="btn btn-secondary btn-round">
          <i class="fas fa-arrow-left"></i> Back to Orders
        </a>
      </div>
    </div>

    <!-- Order Information -->
    <div class="row">
      <div class="col-md-8">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Order Information</div>
              <div class="card-tools">
                <span class="badge badge-primary">Order #{{ order.id }}</span>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-muted mb-3">Customer Information</h6>
                <div class="d-flex align-items-center mb-3">
                  <div class="avatar-lg bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                    <span class="text-white fw-bold fs-4">{{ order.user.firstname[0] }}{{ order.user.lastname[0] }}</span>
                  </div>
                  <div>
                    <div class="fw-bold fs-5">{{ order.user.firstname }} {{ order.user.lastname }}</div>
                    <div class="text-muted">{{ order.user.email }}</div>
                    <small class="text-muted">Customer since {{ order.user.created_at.strftime('%b %Y') }}</small>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="text-muted mb-3">Order Details</h6>
                <div class="row">
                  <div class="col-6">
                    <small class="text-muted">Order Type</small>
                    <div class="fw-bold">{{ order.ordertype.name }}</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Branch</small>
                    <div class="fw-bold">{{ order.branch.name }}</div>
                  </div>
                </div>
                                                  <div class="row mt-2">
                   <div class="col-6">
                     <small class="text-muted">Created</small>
                     <div class="fw-bold">{{ order.created_at.strftime('%b %d, %Y') }}</div>
                   </div>
                   <div class="col-6">
                     <small class="text-muted">Time</small>
                     <div class="fw-bold">{{ order.created_at_adjusted.strftime('%I:%M %p') }}</div>
                   </div>
                 </div>
                 {% if order.approved_at %}
                 <div class="row mt-2">
                   <div class="col-6">
                     <small class="text-muted">Approved</small>
                     <div class="fw-bold">{{ order.approved_at.strftime('%b %d, %Y') }}</div>
                   </div>
                   <div class="col-6">
                     <small class="text-muted">Time</small>
                     <div class="fw-bold">{{ order.approved_at_adjusted.strftime('%I:%M %p') }}</div>
                   </div>
                 </div>
                 {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Order Status</div>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <small class="text-muted">Approval Status</small>
              <div class="mt-1">
                {% if order.approvalstatus %}
                  <span class="badge badge-success fs-6">
                    <i class="fas fa-check"></i> Approved
                  </span>
                {% else %}
                  <span class="badge badge-warning fs-6">
                    <i class="fas fa-clock"></i> Pending Approval
                  </span>
                {% endif %}
              </div>
            </div>
            
            <div class="mb-3">
              <small class="text-muted">Payment Status</small>
              <div class="mt-1">
                {% if payment_status == 'paid' %}
                  <span class="badge badge-success fs-6">
                    <i class="fas fa-credit-card"></i> Paid
                  </span>
                {% elif payment_status == 'partially_paid' %}
                  <span class="badge badge-warning fs-6">
                    <i class="fas fa-clock"></i> Partially Paid
                  </span>
                {% elif payment_status == 'not_paid' %}
                  <span class="badge badge-danger fs-6">
                    <i class="fas fa-times"></i> Not Paid
                  </span>
                {% else %}
                  <span class="badge badge-secondary fs-6">{{ payment_status }}</span>
                {% endif %}
              </div>
            </div>
            
            <div class="mb-3">
              <small class="text-muted">Payments Received</small>
              <div class="fw-bold fs-5 text-success">KSh {{ "%.2f"|format(total_payments) }}</div>
            </div>
            
            <div class="mb-3">
              <small class="text-muted">Remaining Balance</small>
              <div class="fw-bold fs-5 {% if (total_amount - total_payments) > 0 %}text-danger{% else %}text-success{% endif %}">
                KSh {{ "%.2f"|format(total_amount - total_payments) }}
              </div>
            </div>
            
                         <div class="mb-3">
               <small class="text-muted">Total Amount</small>
               <div class="fw-bold fs-4 text-primary">KSh {{ "%.2f"|format(total_amount) }}</div>
             </div>
             
                           <div class="mb-3">
                <small class="text-muted">Total Profit</small>
                <div class="fw-bold fs-4 text-success">
                  KSh {{ "%.2f"|format(total_profit) }}
                </div>
              </div>
             
             <div class="d-grid gap-2">
              {% if not order.approvalstatus %}
              <button type="button" class="btn btn-success" onclick="approveOrder({{ order.id }})">
                <i class="fas fa-check"></i> Approve Order
              </button>
              {% else %}
              <button type="button" class="btn btn-warning" onclick="rejectOrder({{ order.id }})">
                <i class="fas fa-times"></i> Reject Order
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Items -->
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Order Items</div>
              <div class="card-tools">
                <span class="badge badge-primary">{{ order.order_items|length }} items</span>
              </div>
            </div>
          </div>
          <div class="card-body">
            {% if order.order_items %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                                         <th>Product</th>
                     <th>Category</th>
                     
                     <th>Selling Price</th>
                     <th>Buying Price</th>
                     <th>Profit</th>
                     <th>Quantity</th>
                     <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in order.order_items %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        {% if item.branch_product and item.branch_product.catalog_product and item.branch_product.catalog_product.image_url %}
                        <img src="{{ item.branch_product.catalog_product.image_url }}" alt="{{ item.branch_product.catalog_product.name }}" class="me-3" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">
                        {% else %}
                        <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                          <i class="fas fa-box text-muted"></i>
                        </div>
                        {% endif %}
                        <div>
                          <div class="fw-bold">
                            {% if item.branch_product and item.branch_product.catalog_product %}
                              {{ item.branch_product.catalog_product.name }}
                            {% elif item.product_name %}
                              {{ item.product_name }}
                            {% else %}
                              Product Not Found
                            {% endif %}
                          </div>
                          {% if item.branch_product and item.branch_product.catalog_product and item.branch_product.catalog_product.productcode %}
                          <small class="text-muted">Code: {{ item.branch_product.catalog_product.productcode }}</small>
                          {% elif item.branch_productid %}
                          <small class="text-muted">From Catalog</small>
                          {% elif item.product_name %}
                          <small class="text-muted text-warning">Manual Entry</small>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td>
                      {% if item.branch_product and item.branch_product.catalog_product and item.branch_product.catalog_product.subcategory and item.branch_product.catalog_product.subcategory.category %}
                      <span class="badge badge-info">{{ item.branch_product.catalog_product.subcategory.category.name }}</span>
                      {% else %}
                      <span class="badge badge-secondary">N/A</span>
                      {% endif %}
                    </td>
                                        
                     <td>
                       {% if item.final_price %}
                       <strong class="text-primary">KSh {{ "%.2f"|format(item.final_price) }}</strong>
                       {% else %}
                       <span class="text-muted">N/A</span>
                       {% endif %}
                     </td>
                     <td>
                       {% if item.buying_price %}
                       <span class="text-muted">KSh {{ "%.2f"|format(item.buying_price) }}</span>
                       {% elif item.branch_product and item.branch_product.buyingprice %}
                       <span class="text-muted">KSh {{ "%.2f"|format(item.branch_product.buyingprice) }}</span>
                       {% else %}
                       <span class="text-muted">N/A</span>
                       {% endif %}
                     </td>
                     <td>
                       {% if item.final_price %}
                         {% if item.buying_price %}
                           {% set item_profit = (item.final_price - item.buying_price) * item.quantity %}
                           <strong class="text-success">KSh {{ "%.2f"|format(item_profit) }}</strong>
                         {% elif item.branch_product and item.branch_product.buyingprice %}
                           {% set item_profit = (item.final_price - item.branch_product.buyingprice) * item.quantity %}
                           <strong class="text-success">KSh {{ "%.2f"|format(item_profit) }}</strong>
                         {% else %}
                           <span class="text-muted">N/A</span>
                         {% endif %}
                       {% elif item.branch_product and item.branch_product.sellingprice and item.branch_product.buyingprice %}
                         {% set item_profit = (item.branch_product.sellingprice - item.branch_product.buyingprice) * item.quantity %}
                         <strong class="text-success">KSh {{ "%.2f"|format(item_profit) }}</strong>
                       {% else %}
                         <span class="text-muted">N/A</span>
                       {% endif %}
                     </td>
                    <td>
                      <span class="badge badge-primary fs-6">{{ item.quantity | format_quantity }}</span>
                    </td>
                    <td>
                      {% if item.final_price %}
                      <strong>KSh {{ "%.2f"|format(item.final_price * item.quantity) }}</strong>
                      {% elif item.product and item.product.sellingprice %}
                      <strong>KSh {{ "%.2f"|format(item.product.sellingprice * item.quantity) }}</strong>
                      {% else %}
                      <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr class="table-active">
                    <td colspan="7" class="text-end fw-bold">Total:</td>
                    <td class="fw-bold fs-5 text-primary">KSh {{ "%.2f"|format(total_amount) }}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            {% else %}
            <div class="text-center py-4">
              <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No items found</h5>
              <p class="text-muted">This order doesn't have any items.</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Information -->
    {% if order.payments %}
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <div class="card-title">Payment Information</div>
              <div class="card-tools">
                <span class="badge badge-primary">{{ order.payments|length }} payments</span>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Payment ID</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>Reference</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for payment in order.payments %}
                  <tr>
                    <td>
                      <strong>#{{ payment.id }}</strong>
                    </td>
                    <td>
                      <strong>KSh {{ "%.2f"|format(payment.amount) }}</strong>
                    </td>
                    <td>
                      <span class="badge badge-info">{{ payment.payment_method }}</span>
                    </td>
                    <td>
                      {% if payment.payment_status == 'completed' %}
                        <span class="badge badge-success">
                          <i class="fas fa-check"></i> Completed
                        </span>
                      {% elif payment.payment_status == 'pending' %}
                        <span class="badge badge-warning">
                          <i class="fas fa-clock"></i> Pending
                        </span>
                      {% elif payment.payment_status == 'failed' %}
                        <span class="badge badge-danger">
                          <i class="fas fa-times"></i> Failed
                        </span>
                      {% elif payment.payment_status == 'refunded' %}
                        <span class="badge badge-info">
                          <i class="fas fa-undo"></i> Refunded
                        </span>
                      {% else %}
                        <span class="badge badge-secondary">{{ payment.payment_status }}</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if payment.reference_number %}
                      <small class="text-muted">{{ payment.reference_number }}</small>
                      {% else %}
                      <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                                                              <td>
                       <div>
                         <div>{{ payment.created_at.strftime('%b %d, %Y') }}</div>
                         <small class="text-muted">{{ payment.created_at_adjusted.strftime('%I:%M %p') }}</small>
                       </div>
                     </td>
                     <td>
                       <button type="button" class="btn btn-sm btn-primary me-2" 
                               onclick="editPayment({{ payment.id }}, {{ order.id }}, '{{ payment.payment_method }}', {{ payment.amount }}, '{{ payment.payment_status }}', '{{ payment.reference_number or '' }}')"
                               title="Edit Payment">
                         <i class="fas fa-edit"></i>
                       </button>
                       <button type="button" class="btn btn-sm btn-danger" 
                               onclick="deletePayment({{ payment.id }}, {{ order.id }})"
                               title="Delete Payment">
                         <i class="fas fa-trash"></i>
                       </button>
                     </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Edit Payment Modal -->
<div class="modal fade" id="editPaymentModal" tabindex="-1" aria-labelledby="editPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPaymentModalLabel">Edit Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editPaymentForm" method="POST" action="{{ url_for('edit_payment') }}">
        <div class="modal-body">
          <input type="hidden" id="editPaymentId" name="payment_id" value="">
          <input type="hidden" id="editOrderId" name="order_id" value="">
          
          <div class="mb-3">
            <label for="editPaymentMethod" class="form-label">Payment Method</label>
            <select class="form-control" id="editPaymentMethod" name="payment_method" required>
              <option value="cash">Cash</option>
              <option value="mpesa">M-Pesa</option>
              <option value="card">Card</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="cheque">Cheque</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="editAmount" class="form-label">Amount (KSh)</label>
            <input type="number" class="form-control" id="editAmount" name="amount" 
                   step="0.01" min="0" required>
          </div>
          
          <div class="mb-3">
            <label for="editPaymentStatus" class="form-label">Payment Status</label>
            <select class="form-control" id="editPaymentStatus" name="payment_status" required>
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
              <option value="refunded">Refunded</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="editReferenceNumber" class="form-label">Reference Number</label>
            <input type="text" class="form-control" id="editReferenceNumber" name="reference_number" 
                   placeholder="Enter reference number (optional)">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Approve/Reject Confirmation Modals -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approveModalLabel">Confirm Approval</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to approve this order?</p>
        <p class="text-success"><small>This will mark the order as approved.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="approveForm" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-success">Approve Order</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectModalLabel">Confirm Rejection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to reject this order?</p>
        <p class="text-warning"><small>This will mark the order as pending approval.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="rejectForm" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-warning">Reject Order</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function approveOrder(orderId) {
    document.getElementById('approveForm').action = "{{ url_for('approve_order', order_id=0) }}".replace('0', orderId);
    
    const approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
    approveModal.show();
}

function rejectOrder(orderId) {
    document.getElementById('rejectForm').action = "{{ url_for('reject_order', order_id=0) }}".replace('0', orderId);
    
    const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
    rejectModal.show();
}

// Add some styling for the avatar
document.addEventListener('DOMContentLoaded', function() {
    // Add custom styles for better appearance
    const style = document.createElement('style');
    style.textContent = `
        .avatar-lg {
            width: 60px;
            height: 60px;
            font-size: 20px;
        }
        .table td {
            vertical-align: middle;
        }
        .badge {
            font-size: 0.75em;
        }
    `;
    document.head.appendChild(style);
});

// Edit Payment Function
function editPayment(paymentId, orderId, paymentMethod, amount, paymentStatus, referenceNumber) {
    // Set the form values
    document.getElementById('editPaymentId').value = paymentId;
    document.getElementById('editOrderId').value = orderId;
    document.getElementById('editPaymentMethod').value = paymentMethod;
    document.getElementById('editAmount').value = amount;
    document.getElementById('editPaymentStatus').value = paymentStatus;
    document.getElementById('editReferenceNumber').value = referenceNumber || '';
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editPaymentModal'));
    modal.show();
}

// Delete Payment Function
function deletePayment(paymentId, orderId) {
    if (confirm('Are you sure you want to delete this payment? This action cannot be undone.')) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{{ url_for('delete_payment') }}`;
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        // Add payment ID
        const paymentInput = document.createElement('input');
        paymentInput.type = 'hidden';
        paymentInput.name = 'payment_id';
        paymentInput.value = paymentId;
        form.appendChild(paymentInput);
        
        // Add order ID for redirect
        const orderInput = document.createElement('input');
        orderInput.type = 'hidden';
        orderInput.name = 'order_id';
        orderInput.value = orderId;
        form.appendChild(orderInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %} 