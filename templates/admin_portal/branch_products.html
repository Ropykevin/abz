{% extends "navbars.html" %}

<!-- END nav -->
{% block content %}
<style>
.action-buttons {
  display: flex;
  gap: 2px;
  flex-wrap: wrap;
}
.action-buttons .btn {
  min-width: 32px;
  height: 32px;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

/* Search Bar Styling */
.search-container {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 1px solid #e9ecef;
}

.search-container .input-group {
  margin-bottom: 10px;
}

.search-container .form-control {
  border-radius: 6px;
}

.search-container .input-group-text {
  background-color: #fff;
  border-right: none;
}

.search-container .form-control {
  border-left: none;
}

.search-container .form-control:focus {
  box-shadow: none;
  border-color: #ced4da;
}

/* Filter Styling */
.filter-container {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.filter-container .form-control {
  min-width: 150px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .filter-container {
    flex-direction: column;
    align-items: stretch;
  }
  
  .filter-container .form-control {
    min-width: auto;
  }
}

/* Branch Header Styling */
.branch-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.branch-header h2 {
  margin: 0;
  font-weight: 600;
}

.branch-header p {
  margin: 5px 0 0 0;
  opacity: 0.9;
}

.branch-stats {
  display: flex;
  gap: 20px;
  margin-top: 15px;
}

.stat-item {
  text-align: center;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  min-width: 100px;
}

.stat-number {
  font-size: 24px;
  font-weight: bold;
  display: block;
}

.stat-label {
  font-size: 12px;
  opacity: 0.8;
}

/* Custom Modal Styles */
.custom-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease-out;
}

.custom-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.custom-modal-content {
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  position: relative;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideIn 0.3s ease-out;
  width: 90%;
  max-width: 500px;
}

.custom-modal-lg {
  max-width: 800px;
}

.custom-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #e9ecef;
  background-color: #f8f9fa;
  border-radius: 8px 8px 0 0;
}

.custom-modal-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #333;
}

.custom-modal-close {
  background: none;
  border: none;
  font-size: 24px;
  font-weight: bold;
  color: #666;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
}

.custom-modal-close:hover {
  background-color: #e9ecef;
  color: #333;
}

.custom-modal-body {
  padding: 20px;
}

.custom-modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 20px;
  border-top: 1px solid #e9ecef;
  background-color: #f8f9fa;
  border-radius: 0 0 8px 8px;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { 
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
  }
  to { 
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Button Styling */
.btn-success {
  background-color: #28a745;
  border-color: #28a745;
}

.btn-success:hover {
  background-color: #218838;
  border-color: #1e7e34;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .custom-modal-content {
    width: 95%;
    margin: 20px;
  }
  
  .custom-modal-lg {
    max-width: 95%;
  }
  
  .custom-modal-header,
  .custom-modal-body,
  .custom-modal-footer {
    padding: 15px;
  }
}
</style>

<!-- Search functionality disabled - using simple form-based search instead -->
<!-- <script src="{{ url_for('static', filename='js/search.js') }}"></script> -->

<div class="container">
  <div class="page-inner">
    <!-- Branch Header -->
    <div class="branch-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2>{{ branch.name }}</h2>
          <p>{{ branch.location }}</p>
        </div>
        <div class="branch-stats">
          <div class="stat-item">
            <span class="stat-number">{{ branch_products|length }}</span>
            <span class="stat-label">Products</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ branch_products|selectattr('display', 'equalto', true)|list|length }}</span>
            <span class="stat-label">Visible</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ branch_products|sum(attribute='stock') }}</span>
            <span class="stat-label">Total Stock</span>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
      <div>
        <h3 class="fw-bold mb-3">Branch Products</h3>
        <h6 class="op-7 mb-2">Manage products for {{ branch.name }} branch</h6>
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <a href="{{ url_for('products') }}" class="btn btn-secondary btn-round">
          <i class="fas fa-arrow-left"></i> All Products
        </a>
        <button class="btn btn-primary btn-round ms-2" onclick="openAddExistingProductModal()">
          <i class="fas fa-list"></i> Add Existing Product
        </button>
        <button class="btn btn-success btn-round ms-2" onclick="openAddNewProductModal()">
          <i class="fas fa-plus"></i> Add New Product
        </button>
      </div>
    </div>

    <!-- Products Section -->
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <h4 class="card-title">
                Products - {{ branch.name }}
              </h4>
              <div class="card-tools">
                <button class="btn btn-icon btn-link btn-primary btn-xs" data-bs-toggle="collapse" data-bs-target="#productsCollapse">
                  <span class="fa fa-angle-down"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="card-body collapse show" id="productsCollapse">
            <!-- Products Search Bar -->
            <div class="search-container">
              <div class="filter-container">
                <form method="GET" action="{{ url_for('branch_products', branch_id=branch.id) }}" class="row g-3">
                  <div class="col-md-3">
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-search"></i></span>
                      <input type="text" class="form-control" id="productSearch" name="search" 
                             value="{{ search }}" placeholder="Search products by name, code, or category...">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <select class="form-control" id="categoryFilter" name="category">
                      <option value="">All Categories</option>
                      {% for subcategory in subcategories %}
                      <option value="{{ subcategory.name }}" {% if category_filter == subcategory.name %}selected{% endif %}>
                        {{ subcategory.name }} ({{ subcategory.category.name }})
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-2">
                    <select class="form-control" id="displayFilter" name="display">
                      <option value="">All Products</option>
                      <option value="true" {% if display_filter == 'true' %}selected{% endif %}>Visible Only</option>
                      <option value="false" {% if display_filter == 'false' %}selected{% endif %}>Hidden Only</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <select class="form-control" name="per_page">
                      <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10 per page</option>
                      <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25 per page</option>
                      <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50 per page</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-search"></i> Search
                    </button>
                    <a href="{{ url_for('branch_products', branch_id=branch.id) }}" class="btn btn-secondary">
                      <i class="fas fa-times"></i> Clear
                    </a>
                  </div>
                </form>
              </div>
              
              <!-- Export Section -->
              <div class="mt-3 d-flex justify-content-end gap-2">
                <a href="{{ url_for('export_products_csv', branch_id=branch.id) }}" 
                   class="btn btn-success btn-sm">
                  <i class="fas fa-download"></i> Export All to CSV
                </a>
                <a href="{{ url_for('export_products_by_category_csv', branch_id=branch.id) }}" 
                   class="btn btn-primary btn-sm">
                  <i class="fas fa-layer-group"></i> Export by Category (CSV)
                </a>
                <a href="{{ url_for('export_products_by_category_pdf', branch_id=branch.id) }}" 
                   class="btn btn-danger btn-sm">
                  <i class="fas fa-file-pdf"></i> Export by Category (PDF)
                </a>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover" id="productsTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Buying Price</th>
                    <th>Selling Price</th>
                    <th>Stock</th>
                    <th>Product Code</th>
                    <th>Display</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for branch_product in branch_products %}
                  <tr>
                    <td>{{ branch_product.id }}</td>
                    <td>
                      {% if branch_product.catalog_product and branch_product.catalog_product.image_url %}
                      <img src="{{ branch_product.catalog_product.image_url }}" alt="{{ branch_product.catalog_product.name }}" style="width: 50px; height: 50px; object-fit: cover;">
                      {% else %}
                      <span class="text-muted">No image</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if branch_product.catalog_product %}
                        {{ branch_product.catalog_product.name }}
                      {% else %}
                        <span class="text-muted">Unknown Product</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if branch_product.catalog_product and branch_product.catalog_product.subcategory_id %}
                        {% for subcategory in subcategories %}
                          {% if subcategory.id == branch_product.catalog_product.subcategory_id %}
                            {{ subcategory.name }} ({{ subcategory.category.name }})
                          {% endif %}
                        {% endfor %}
                      {% else %}
                        <span class="text-muted">No category</span>
                      {% endif %}
                    </td>
                    <td>{{ branch_product.buyingprice or 'N/A' }}</td>
                    <td>{{ branch_product.sellingprice or 'N/A' }}</td>
                    <td>
                      <span class="badge {% if branch_product.stock > 10 %}badge-success{% elif branch_product.stock > 0 %}badge-warning{% else %}badge-danger{% endif %}">
                        {{ branch_product.stock | format_stock }}
                      </span>
                    </td>
                    <td>
                      {% if branch_product.catalog_product %}
                        {{ branch_product.catalog_product.productcode or 'N/A' }}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge {% if branch_product.display %}badge-success{% else %}badge-secondary{% endif %}">
                        {{ 'Visible' if branch_product.display else 'Hidden' }}
                      </span>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-sm btn-success" onclick="addStock({{ branch_product.id }})" title="Add Stock">
                          <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="removeStock({{ branch_product.id }})" title="Remove Stock">
                          <i class="fas fa-minus"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="window.location.href='{{ url_for('stock_history', branch_product_id=branch_product.id) }}'" title="Stock History">
                          <i class="fas fa-history"></i>
                        </button>
                        <a href="{{ url_for('product_descriptions', product_id=branch_product.catalog_product.id) if branch_product.catalog_product else '#' }}" class="btn btn-sm btn-info" title="Manage Descriptions">
                          <i class="fas fa-file-alt"></i>
                        </a>
                        <button class="btn btn-sm btn-primary" onclick="editBranchProduct({{ branch_product.id }})" title="Edit">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleDisplay({{ branch_product.id }})" title="Toggle Display">
                          <i class="fas {% if branch_product.display %}fa-eye-slash{% else %}fa-eye{% endif %}"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBranchProduct({{ branch_product.id }})" title="Delete">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Products pagination">
              <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=pagination.prev_num, search=search, category=category_filter, display=display_filter, per_page=request.args.get('per_page', 10)) }}">
                    <i class="fas fa-chevron-left"></i> Previous
                  </a>
                </li>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                  {% if page_num %}
                    {% if page_num != pagination.page %}
                    <li class="page-item">
                      <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=page_num, search=search, category=category_filter, display=display_filter, per_page=request.args.get('per_page', 10)) }}">{{ page_num }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                  {% else %}
                    <li class="page-item disabled">
                      <span class="page-link">...</span>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=pagination.next_num, search=search, category=category_filter, display=display_filter, per_page=request.args.get('per_page', 10)) }}">
                    Next <i class="fas fa-chevron-right"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
            
            <!-- Result Count -->
            <div class="text-center text-muted mt-3">
              Showing {{ pagination.items|length }} of {{ pagination.total }} branch products in {{ branch.name }}
              {% if search or category_filter or display_filter %}
                (filtered results)
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Existing Product Modal -->
<div id="addExistingProductModal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay" onclick="closeModal('addExistingProductModal')"></div>
  <div class="custom-modal-content custom-modal-lg">
    <div class="custom-modal-header">
      <h5 class="custom-modal-title"><i class="fas fa-list"></i> Add Existing Product to Branch</h5>
      <button type="button" class="custom-modal-close" onclick="closeModal('addExistingProductModal')">&times;</button>
    </div>
    <form action="{{ url_for('add_branch_product') }}" method="POST">
      <div class="custom-modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="catalog_id">Select Product from Catalog *</label>
              <select class="form-control" id="catalog_id" name="catalog_id" required>
                <option value="">Select Product</option>
              </select>
              <small class="form-text text-muted">Choose from existing products in the catalog</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="branchid">Branch *</label>
              <select class="form-control" id="branchid" name="branchid" required>
                <option value="{{ branch.id }}" selected>{{ branch.name }} - {{ branch.location }}</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label for="buyingprice">Buying Price</label>
              <input type="number" class="form-control" id="buyingprice" name="buyingprice" min="0" step="0.01">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="sellingprice">Selling Price</label>
              <input type="number" class="form-control" id="sellingprice" name="sellingprice" min="0" step="0.01">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="stock">Initial Stock</label>
              <input type="number" class="form-control" id="stock" name="stock" min="0" value="0">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <label for="display">Display Status</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="display" name="display" checked>
                <label class="form-check-label" for="display">
                  Visible to customers
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="custom-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('addExistingProductModal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Add to Branch</button>
      </div>
    </form>
  </div>
</div>

<!-- Add New Product Modal -->
<div id="addNewProductModal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay" onclick="closeModal('addNewProductModal')"></div>
  <div class="custom-modal-content custom-modal-lg">
    <div class="custom-modal-header">
      <h5 class="custom-modal-title"><i class="fas fa-plus"></i> Add New Product to Branch</h5>
      <button type="button" class="custom-modal-close" onclick="closeModal('addNewProductModal')">&times;</button>
    </div>
    <form action="{{ url_for('add_new_product_to_branch') }}" method="POST" enctype="multipart/form-data">
      <div class="custom-modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="productName">Product Name *</label>
              <input type="text" class="form-control" id="productName" name="name" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="productCode">Product Code</label>
              <input type="text" class="form-control" id="productCode" name="productcode">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="productSubcategory">Subcategory</label>
              <select class="form-control" id="productSubcategory" name="subcategory_id">
                <option value="">No subcategory</option>
                {% for subcategory in subcategories %}
                <option value="{{ subcategory.id }}">{{ subcategory.name }} ({{ subcategory.category.name }})</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="productImage">Product Image</label>
              <input type="file" class="form-control" id="productImage" name="image" accept="image/*">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label for="newBuyingprice">Buying Price</label>
              <input type="number" class="form-control" id="newBuyingprice" name="buyingprice" min="0" step="0.01">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="newSellingprice">Selling Price</label>
              <input type="number" class="form-control" id="newSellingprice" name="sellingprice" min="0" step="0.01">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="newStock">Initial Stock</label>
              <input type="number" class="form-control" id="newStock" name="stock" min="0" value="0">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="newDisplay">Display Status</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="newDisplay" name="display" checked>
                <label class="form-check-label" for="newDisplay">
                  Visible to customers
                </label>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="newBranchid">Branch *</label>
              <select class="form-control" id="newBranchid" name="branchid" required>
                <option value="{{ branch.id }}" selected>{{ branch.name }} - {{ branch.location }}</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="custom-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('addNewProductModal')">Cancel</button>
        <button type="submit" class="btn btn-success">Create & Add to Branch</button>
      </div>
    </form>
  </div>
</div>

<!-- Custom Add Stock Modal -->
<div id="addStockModal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay" onclick="closeModal('addStockModal')"></div>
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h5 class="custom-modal-title">Add Stock</h5>
      <button type="button" class="custom-modal-close" onclick="closeModal('addStockModal')">&times;</button>
    </div>
    <form id="addStockForm" method="POST">
      <div class="custom-modal-body">
        <div class="form-group">
          <label for="quantity">Quantity to Add</label>
          <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
        </div>
        <div class="form-group">
          <label for="notes">Notes (Optional)</label>
          <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
        </div>
      </div>
      <div class="custom-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('addStockModal')">Cancel</button>
        <button type="submit" class="btn btn-success">Add Stock</button>
      </div>
    </form>
  </div>
</div>

<!-- Custom Remove Stock Modal -->
<div id="removeStockModal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay" onclick="closeModal('removeStockModal')"></div>
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h5 class="custom-modal-title">Remove Stock</h5>
      <button type="button" class="custom-modal-close" onclick="closeModal('removeStockModal')">&times;</button>
    </div>
    <form id="removeStockForm" method="POST">
      <div class="custom-modal-body">
        <div class="form-group">
          <label for="removeQuantity">Quantity to Remove</label>
          <input type="number" class="form-control" id="removeQuantity" name="quantity" min="1" required>
        </div>
        <div class="form-group">
          <label for="removeNotes">Notes (Optional)</label>
          <textarea class="form-control" id="removeNotes" name="notes" rows="3"></textarea>
        </div>
      </div>
      <div class="custom-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('removeStockModal')">Cancel</button>
        <button type="submit" class="btn btn-warning">Remove Stock</button>
      </div>
    </form>
  </div>
</div>

<!-- Custom Edit Branch Product Modal -->
<div id="editBranchProductModal" class="custom-modal" style="display: none;">
  <div class="custom-modal-overlay" onclick="closeModal('editBranchProductModal')"></div>
  <div class="custom-modal-content custom-modal-lg">
    <div class="custom-modal-header">
      <h5 class="custom-modal-title">Edit Branch Product</h5>
      <button type="button" class="custom-modal-close" onclick="closeModal('editBranchProductModal')">&times;</button>
    </div>
    <form id="editBranchProductForm" method="POST">
      <div class="custom-modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label for="editCatalogProductName">Product Name</label>
              <input type="text" class="form-control" id="editCatalogProductName" readonly>
              <small class="form-text text-muted">Product name cannot be changed here. Edit in catalog.</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="editBranchid">Branch</label>
              <input type="text" class="form-control" id="editBranchid" readonly>
              <small class="form-text text-muted">Branch cannot be changed.</small>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label for="editBuyingprice">Buying Price</label>
              <input type="number" class="form-control" id="editBuyingprice" name="buyingprice" min="0" step="0.01">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="editSellingprice">Selling Price</label>
              <input type="number" class="form-control" id="editSellingprice" name="sellingprice" min="0" step="0.01">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="editStock">Stock</label>
              <input type="number" class="form-control" id="editStock" name="stock" min="0" readonly>
              <small class="form-text text-muted">Use stock management buttons to change stock levels.</small>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <label for="editDisplay">Display Status</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editDisplay" name="display">
                <label class="form-check-label" for="editDisplay">
                  Visible to customers
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="custom-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('editBranchProductModal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Update Branch Product</button>
      </div>
    </form>
  </div>
</div>

<script>
// Custom modal functions - no more Bootstrap modal conflicts!
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
}

function openAddExistingProductModal() {
    loadCatalogProducts();
    openModal('addExistingProductModal');
}

function openAddNewProductModal() {
    openModal('addNewProductModal');
}

function addStock(branchProductId) {
    document.getElementById('addStockForm').action = `/add_stock/${branchProductId}`;
    openModal('addStockModal');
}

function removeStock(branchProductId) {
    document.getElementById('removeStockForm').action = `/remove_stock/${branchProductId}`;
    openModal('removeStockModal');
}

function editBranchProduct(branchProductId) {
    fetch(`/get_branch_product/${branchProductId}`)
        .then(response => response.json())
        .then(branchProduct => {
            document.getElementById('editCatalogProductName').value = branchProduct.catalog_product_name || '';
            document.getElementById('editBranchid').value = branchProduct.branchid;
            document.getElementById('editBuyingprice').value = branchProduct.buyingprice || '';
            document.getElementById('editSellingprice').value = branchProduct.sellingprice || '';
            document.getElementById('editStock').value = branchProduct.stock || 0;
            document.getElementById('editDisplay').checked = branchProduct.display;
            
            document.getElementById('editBranchProductForm').action = `/edit_branch_product/${branchProductId}`;
            openModal('editBranchProductModal');
        })
        .catch(error => {
            console.error('Error fetching branch product:', error);
            alert('Error loading branch product data');
        });
}

function deleteBranchProduct(branchProductId) {
    if (confirm('Are you sure you want to delete this branch product? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_branch_product/${branchProductId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function toggleDisplay(branchProductId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/toggle_display/${branchProductId}`;
    document.body.appendChild(form);
    form.submit();
}

// Load catalog products for the add modal
function loadCatalogProducts() {
    const branchId = {{ branch.id }};
    fetch(`/get_catalog_products_for_branch?branch_id=${branchId}`)
        .then(response => response.json())
        .then(products => {
            const select = document.getElementById('catalog_id');
            select.innerHTML = '<option value="">Select Product</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.productcode || 'No Code'})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading catalog products:', error);
        });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCatalogProducts();
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const openModals = document.querySelectorAll('.custom-modal[style*="flex"]');
            openModals.forEach(modal => {
                modal.style.display = 'none';
            });
            document.body.style.overflow = 'auto';
        }
    });
    
    console.log('Custom modal system initialized - simple search without AJAX');
});
</script>
{% endblock %} 